#
# $Id: makl_func_strerror_r,v 1.6 2005/12/13 16:11:42 stewy Exp $
#

#\brief Define HAVE_STRERROR_R if strerror_r() is found, and STRERROR_R_CHAR_P
#       if it returns a char pointer (returns int on some systems).
#       $1 determines whether the feature is optional or required.
#   
#   \param $1 0:optional,1:required
#
makl_func_strerror_r ()
{
    [ -z `makl_get "__noconfig__"` ] || return

    makl_dbg "checking for function 'strerror_r'"

    # test function compilation 
    ${ECHO} "
        char buf[100];
        strerror_r(0, buf, sizeof(buf));
    " | makl_compile_code 1

    if [ $? = 0 ]; then
        
        # Determine whether strerror_r returns a char* or an int by forcing a
        # char* return value with extern() and using isalpha() on the returned string.
        # A bus error may be caused if the return value is not a string.
        ${ECHO} "
            extern char *strerror_r();
        
            int main() {
                char buf[100];
                char x = *strerror_r(0, buf, sizeof(buf));
                return (!isalpha(x));
            }
        " | makl_exec_code 0

        if [ $? = 0 ]; then
            makl_set_var_h "STRERROR_R_CHAR_P"
        fi

        makl_set_var_h "HAVE_STRERROR_R"

        return 0
    else
        [ $1 = 0 ] || makl_err 2 "failed check on required function strerror_r!"
        makl_warn "failed check on optional function strerror_r"
        return 1
    fi
}
