#!/bin/sh
#
# $Id: maklsh.in,v 1.25 2008/03/05 17:21:24 tho Exp $

export MAKL_DIR="@{{MAKL_ROOT}}"
export MAKEFLAGS="-I ${MAKL_DIR}/mk"

MAKL_VERSION=`cat ${MAKL_DIR}/VERSION 2>/dev/null`
PATH_CF_SCRIPT=""       # must be set by search_cf_script()
PATH_GNUMAKE=@{{GNU_MAKE}}

ECHO="/bin/echo"

# these are the defaults: users can expand it through MAKL_CF_SCRIPTS variable
# (read from their ${HOME}/.maklrc)
CF_SCRIPTS="./configure.sh  \
            ./Config.sh     \
            ./config.sh     \
            ./Configure.sh  \
            ./configure     \
            ./Configure"

maklsh_echo ()
{
    ${ECHO} -n "[makl] "
    ${ECHO} $@
}

search_cf_script ()
{
    for cf in ${CF_SCRIPTS}
    do
        if [ -x ${cf} ]; then
            PATH_CF_SCRIPT=${cf} 
            maklsh_echo "using configure script: ${PATH_CF_SCRIPT}"
            return 0
        fi
    done

    maklsh_echo "no suitable configure script found!"
    return 1
}

search_nearest_maklrc ()
{
    cdir="."
    depth=5 # default search depth value: can be overridden by MAKL_RC_MAXDEPTH

    [ "${MAKL_RC_MAXDEPTH}" ] && depth=${MAKL_RC_MAXDEPTH}

    while expr ${depth} '>' 0 >/dev/null
    do
        depth=`expr ${depth} - 1`
        if [ -r ${cdir}"/.maklrc" ]
        then
            CDIR=`(cd ${cdir} && pwd)`
            maklsh_echo "reading per-project MAKL vars from ${CDIR}/.maklrc"
            return 0
        fi
        cdir="../"${cdir}
    done

    return 1
}

display_help ()
{
    ${ECHO} "MaKL version ${MAKL_VERSION}, (c) 2005-2008 Koanlogic srl         "
    ${ECHO} "This is free software released under the BSD license.             "
    ${ECHO} "                                                                  "
    ${ECHO} "Available tools are:                                              "
    ${ECHO} "makl       => GNU make wrapper                                    "
    ${ECHO} "makl-conf  => configure script wrapper                            "
    ${ECHO} "makl-tc    => toolchain installer                                 "
    ${ECHO} "makl-new   => create Makefile from template                       "
    ${ECHO} "makl-help  => display this help                                   "
    ${ECHO} "                                                                  "
    ${ECHO} "MaKL variable in use:                                             "
    ${ECHO} "MAKL_DIR  [${MAKL_DIR}]"
    ${ECHO} "MAKEFLAGS [${MAKEFLAGS}]"
    ${ECHO} "MAKL_ETC  [${MAKL_ETC}]"

    return
}

toolchain_env ()
{
    # accumulate the needed variables into ENV
    [ "${MAKL_TC}" ] && ENV="MAKL_TC=${MAKL_TC}"
    [ "${MAKL_TC_FILE}" ] && ENV="${ENV} MAKL_TC_FILE=${MAKL_TC_FILE}"
    [ "${MAKL_SHLIB}" ] && ENV="${ENV} MAKL_SHLIB=${MAKL_SHLIB}"
    [ "${MAKL_SHLIB_FILE}" ] && ENV="${ENV} MAKL_SHLIB_FILE=${MAKL_SHLIB_FILE}"
    [ "${MAKL_ETC}" ] && ENV="${ENV} MAKL_ETC=${MAKL_ETC}"

    # check if there's anything into ENV
    if [ -z "${ENV}" ]
    then
        maklsh_echo "at least one of MAKL_TC, MAKL_SHLIB, MAKL_ETC must be set!"
        return 1
    fi

    return 0
}

display_maklnew_help()
{
    ${ECHO}
    ${ECHO} "usage: maklnew <template>"
    ${ECHO}
    ${ECHO} "available templates:"
    ${ECHO} "   prog lib subdir xeno include script file man dist subst"
    ${ECHO}
}

clone_from_tmpl ()
{
    local mf="./Makefile"

    if [ -z "$1" ]
    then  
        display_maklnew_help
        return 1 
    fi

    case $1
    in
        prog|lib|subdir|xeno|include|script|file|man|dist|subst)
            [ $1 = "dist" ] && mf="Makefile.dist"
            cp -i ${MAKL_DIR}/tmpl/$1.tmpl $mf
            if [ $? = 0 ] 
            then
                maklsh_echo "'$1' template successfully saved to $mf."
                maklsh_echo "type 'makl .help' to get the list of" \
                    "available targets and variables."
            fi
            ;;
        *)
            maklsh_echo "no template for '$1'"
            display_maklnew_help
            return 1
            ;;
    esac
}

# get overrides from the user 
[ -f ${HOME}/.maklrc ] && . ${HOME}/.maklrc

# further overrides are taken from per-project .maklrc's
search_nearest_maklrc
[ $? = 0 ] && . "${CDIR}"/.maklrc

# merge configure scripts naming from user (user settings have precedence)
CF_SCRIPTS="${MAKL_CF_SCRIPTS} ${CF_SCRIPTS}"

# dispatch action based on how we were called
case `basename $0`
in
    makl)
        # exec GNU make with user supplied arguments
        ${PATH_GNUMAKE} $@
        exit $?
        ;;
    maklconf|makl-conf)
        search_cf_script || exit 1
        # exec the selected configure script with user supplied arguments
        ${PATH_CF_SCRIPT} $@ 
        exit $?
        ;;
    maklhelp|makl-help)
        display_help
        exit 0
        ;;
    makltc|makl-tc)
        toolchain_env || exit 1
        env ${ENV} ${MAKL_DIR}/setup/tc_setup.sh
        exit $?
        ;;
    maklnew|makl-new)
        clone_from_tmpl $@
        exit $?
        ;;
    *)
        maklsh_echo "don't call me directly!"
        display_help
        exit 1
        ;;
esac

# should never reach here
exit 1
