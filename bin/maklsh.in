#!/bin/sh
#
# $Id: maklsh.in,v 1.10 2007/07/03 14:50:52 tho Exp $

export MAKL_DIR="@{{MAKL_ROOT}}"
export MAKEFLAGS="-I ${MAKL_DIR}/mk"

MAKL_VERSION=`cat ${MAKL_DIR}/VERSION 2>/dev/null`
PATH_CF_SCRIPT=""       # must be set by search_cf_script()
PATH_GNUMAKE=@{{GNU_MAKE}}

# these are the defaults: users can expand it through MAKL_CF_SCRIPTS variable
# (read from their ${HOME}/.maklrc)
CF_SCRIPTS="./configure.sh  \
            ./Config.sh     \
            ./config.sh     \
            ./Configure.sh  \
            ./configure     \
            ./Configure"

search_cf_script ()
{
    for cf in ${CF_SCRIPTS}
    do
        if [ -x ${cf} ]; then
            PATH_CF_SCRIPT=${cf} 
            return
        fi
    done

    echo "no suitable configure script found" && exit 1
}

search_nearest_maklrc ()
{
    cdir="."
    depth=5 # default search depth value: can be overridden by MAKL_RC_MAXDEPTH

    [ "${MAKL_RC_MAXDEPTH}" ] && depth=${MAKL_RC_MAXDEPTH}

    while expr ${depth} '>' 0 >/dev/null
    do
        depth=`expr ${depth} - 1`
        [ -r ${cdir}"/.maklrc" ] && return 0
        cdir="../"${cdir}
    done

    return 1
}

display_help ()
{
    echo "MaKL version ${MAKL_VERSION}, (c) 2005-2007 Koanlogic srl         "
    echo "This is free software released under the BSD license.             "
    echo "                                                                  "
    echo "Available tools are:                                              "
    echo "makl      => GNU make wrapper                                     "
    echo "maklconf  => configure script wrapper                             "
    echo "maklhelp  => display this help                                    "
    echo "                                                                  "
    echo "MaKL variable in use are:                                         "
    echo "MAKL_DIR = ${MAKL_DIR}                                            "
    echo "MAKEFLAGS = ${MAKEFLAGS}                                          "
    echo "MAKL_ETC = ${MAKL_ETC}                                            "
    exit 0
}

# get overrides from the user 
[ -f ${HOME}/.maklrc ] && . ${HOME}/.maklrc

# further overrides are taken from per-project .maklrc's
search_nearest_maklrc
[ $? == 0 ] && . `(cd ${cdir} && pwd)`/.maklrc

# merge configure scripts naming from user (user settings have precedence)
CF_SCRIPTS="${MAKL_CF_SCRIPTS} ${CF_SCRIPTS}"

# dispatch action based on how we were called
case `basename $0`
in
    makl)
        # exec GNU make with user supplied arguments
        ${PATH_GNUMAKE} $@
        exit $?
        ;;
    maklconf)
        search_cf_script
        # exec the selected configure script with user supplied arguments
        ${PATH_CF_SCRIPT} $@ 
        exit $?
        ;;
    maklhelp)
        display_help
        exit 0
        ;;
    *)
        echo "don't call me directly, instead call me as makl or maklconf"
        exit 1
        ;;
esac

# should never reach here
exit 1
